name: Build and Publish IOS

on:
  push:
    branches:
      - master

env:
  SIGN: false

jobs:
  build-and-publish-jvm-android:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Make gradlew executable again
        run: chmod +x ./gradlew

      - name: Publish to Sonatype repository
        run: |
          ./gradlew clean publishToMavenLocal
          ls -ln ./build/libs && echo 'Complete'
        #run: ./gradlew clean publishAllPublicationsToSonatypeRepository

  build-and-release-ios:
    runs-on: macos-latest
    steps:
      - name: Check Out
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Make gradlew executable again
        run: chmod +x ./gradlew

      - name: Build XCFramework
        run: ./gradlew clean podPublishXCFramework

      - name: Checkout ios sources
        uses: actions/checkout@v3
        with:
          path: biometric-sdk-ios-release
          repository: biometric-technologies/biometric-sdk-ios-release
          ref: master

      - name: Update ios sources
        working-directory: ./biometric-sdk-ios-release
        run: cp -a ./../build/cocoapods/publish/debug/. .

      - name: Commit ios sources
        working-directory: ./biometric-sdk-ios-release
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git commit -a -m "New SDK release"
        # git tag v1.0.0

      - name: Push ios sources
        uses: ad-m/github-push-action@master
        with:
          repository: biometric-technologies/biometric-sdk-ios-release
          directory: biometric-sdk-ios-release
          github_token: ${{ secrets.GIT_IOS_RELEASE_TOKEN }}
          ssh: true
          branch: master

      - name: Install Cocoapods
        run: gem install cocoapods

      - name: Release library
        working-directory: ./biometric-sdk-ios-release
        #run: pod trunk push BiometricSdk.podspec
        run: ls -ln && echo 'Complete'
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}